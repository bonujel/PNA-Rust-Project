# PingCAP Talent Plan - Rust å®è·µï¼šæ—¥å¿—ç»“æ„åŒ–é”®å€¼å­˜å‚¨

[PingCAP Talent Plan](https://github.com/pingcap/talent-plan) Rust è¯¾ç¨‹å®è·µé¡¹ç›®ï¼Œå®ç°äº†ä¸€ä¸ªåŸºäº Bitcask å­˜å‚¨æ¨¡å‹çš„å¤šçº¿ç¨‹æŒä¹…åŒ–é”®å€¼å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒå®¢æˆ·ç«¯-æœåŠ¡ç«¯ç½‘ç»œæ¶æ„ã€å¯æ’æ‹”å­˜å‚¨å¼•æ“å’Œçº¿ç¨‹æ± å¹¶å‘å¤„ç†ã€‚

## é¡¹ç›®è¿›åº¦

| é˜¶æ®µ | çŠ¶æ€ | æè¿° |
|------|------|------|
| Project 1 | âœ… å®Œæˆ | å†…å­˜é”®å€¼å­˜å‚¨ + CLI æ¡†æ¶ |
| Project 2 | âœ… å®Œæˆ | æ—¥å¿—ç»“æ„åŒ–æ–‡ä»¶ I/O + å‹ç¼© |
| Project 3 | âœ… å®Œæˆ | åŒæ­¥å®¢æˆ·ç«¯-æœåŠ¡ç«¯ç½‘ç»œ + å¯æ’æ‹”å¼•æ“ |
| Project 4 | âœ… å®Œæˆ | å¹¶å‘ä¸å¹¶è¡Œï¼šçº¿ç¨‹æ±  + æ— é”è¯»å– |
| Project 5 | ğŸ”² å¾…å¼€å§‹ | å¼‚æ­¥ I/O |

## é¡¹ç›®ç»“æ„

```
project/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs                  # åº“å…¥å£ï¼Œæ¨¡å—å¯¼å‡º
â”‚   â”œâ”€â”€ error.rs                # è‡ªå®šä¹‰é”™è¯¯ç±»å‹ (thiserror)
â”‚   â”œâ”€â”€ common.rs               # å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡åè®® (Request/Response)
â”‚   â”œâ”€â”€ server.rs               # KvsServer<E, P> â€” å¤šçº¿ç¨‹ TCP æœåŠ¡ç«¯
â”‚   â”œâ”€â”€ client.rs               # KvsClient â€” TCP å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ engines/
â”‚   â”‚   â”œâ”€â”€ mod.rs              # KvsEngine trait (Clone + Send + 'static)
â”‚   â”‚   â”œâ”€â”€ kvs.rs              # KvStore â€” Bitcask å¼•æ“ (æ— é”å¹¶å‘è¯»)
â”‚   â”‚   â””â”€â”€ sled_engine.rs      # SledKvsEngine é€‚é…å™¨
â”‚   â”œâ”€â”€ thread_pool/
â”‚   â”‚   â”œâ”€â”€ mod.rs              # ThreadPool trait
â”‚   â”‚   â”œâ”€â”€ naive.rs            # NaiveThreadPool (æ¯ä»»åŠ¡æ–°çº¿ç¨‹)
â”‚   â”‚   â”œâ”€â”€ shared_queue.rs     # SharedQueueThreadPool (MPMC å…±äº«é˜Ÿåˆ—)
â”‚   â”‚   â””â”€â”€ rayon_pool.rs       # RayonThreadPool (work-stealing)
â”‚   â””â”€â”€ bin/
â”‚       â”œâ”€â”€ kvs-server.rs       # æœåŠ¡ç«¯ CLI
â”‚       â””â”€â”€ kvs-client.rs       # å®¢æˆ·ç«¯ CLI
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ kv_store.rs             # å­˜å‚¨å¼•æ“é›†æˆæµ‹è¯• (8 ä¸ªï¼Œå«å¹¶å‘æµ‹è¯•)
â”‚   â”œâ”€â”€ thread_pool.rs          # çº¿ç¨‹æ± æµ‹è¯• (4 ä¸ªï¼Œå« panic æ¢å¤)
â”‚   â””â”€â”€ cli.rs                  # å®¢æˆ·ç«¯-æœåŠ¡ç«¯ CLI æµ‹è¯• (11 ä¸ª)
â”œâ”€â”€ benches/
â”‚   â””â”€â”€ engine_bench.rs         # kvs vs sled æ€§èƒ½åŸºå‡†æµ‹è¯•
â””â”€â”€ examples/
    â”œâ”€â”€ tcp_json_client.rs      # TCP + JSON æµå¼åè®®ç¤ºä¾‹
    â””â”€â”€ tcp_json_server.rs
```

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         TCP/JSON          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KvsClient   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           KvsServer<E, P>        â”‚
â”‚              â”‚   Request { Set/Get/Rm }  â”‚                                  â”‚
â”‚  kvs-client  â”‚   Response { Ok/Err }    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚    ThreadPool trait (P)   â”‚    â”‚
                                          â”‚  â”‚  Naive â”‚ SharedQ â”‚ Rayon â”‚    â”‚
                                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                          â”‚             â”‚ spawn(job)         â”‚
                                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                                          â”‚  â”‚    KvsEngine trait (E)    â”‚    â”‚
                                          â”‚  â”‚  Clone + Send + 'static  â”‚    â”‚
                                          â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
                                          â”‚  â”‚ KvStore      â”‚ SledKvs   â”‚    â”‚
                                          â”‚  â”‚ (Bitcask)    â”‚ (sled)    â”‚    â”‚
                                          â”‚  â”‚ æ— é”å¹¶å‘è¯»   â”‚ å†…ç½®å¹¶å‘  â”‚    â”‚
                                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒå¹¶å‘æœºåˆ¶ (KvStore)ï¼š**
- **æ— é”è¯»å–**ï¼šæ¯ä¸ªçº¿ç¨‹æŒæœ‰ç‹¬ç«‹çš„ `RefCell<HashMap<u64, BufReader>>` æ–‡ä»¶å¥æŸ„ï¼Œè¯»æ“ä½œæ— éœ€åŠ é”
- **å†™å…¥ä¸²è¡ŒåŒ–**ï¼š`Arc<Mutex<KvStoreWriter>>` ä¿è¯å†™å…¥åŸå­æ€§ï¼Œé˜²æ­¢ TOCTOU ç«æ€
- **å…±äº«ç´¢å¼•**ï¼š`Arc<RwLock<HashMap>>` è¯»å†™é”ä¿æŠ¤å†…å­˜ç´¢å¼•ï¼Œè¯»å¤šå†™å°‘åœºæ™¯é«˜æ•ˆ
- **å®‰å…¨ç‚¹æœºåˆ¶**ï¼š`AtomicU64` safe_point æ ‡è®°å‹ç¼©è¿›åº¦ï¼Œè¯»çº¿ç¨‹æƒ°æ€§æ¸…ç†è¿‡æœŸæ–‡ä»¶å¥æŸ„

**çº¿ç¨‹æ± å®ç°ï¼š**
- **NaiveThreadPool**ï¼šæ¯ä»»åŠ¡åˆ›å»ºæ–°çº¿ç¨‹ï¼ŒåŸºçº¿å¯¹ç…§
- **SharedQueueThreadPool**ï¼šcrossbeam MPMC é€šé“ + `catch_unwind` panic æ¢å¤
- **RayonThreadPool**ï¼šwork-stealing è°ƒåº¦ï¼Œç”Ÿäº§æ¨è

## æŠ€æœ¯æ ˆ

| ä¾èµ– | ç”¨é€” |
|------|------|
| `clap v4.5` (derive) | CLI å‚æ•°è§£æ |
| `serde` + `serde_json` | å‘½ä»¤åºåˆ—åŒ–/ååºåˆ—åŒ– + TCP æµå¼åè®® |
| `thiserror v2.0` | å£°æ˜å¼é”™è¯¯ç±»å‹ |
| `env_logger` + `log` | æ—¥å¿—è®°å½• |
| `sled v0.34` | åµŒå…¥å¼æ•°æ®åº“å¼•æ“ |
| `crossbeam v0.8` | MPMC æ— é”é€šé“ (çº¿ç¨‹æ± ) |
| `rayon v1` | work-stealing çº¿ç¨‹æ±  |
| `num_cpus` | CPU æ ¸å¿ƒæ•°æ£€æµ‹ |
| `criterion v0.5` | æ€§èƒ½åŸºå‡†æµ‹è¯• |

## ä½¿ç”¨æ–¹æ³•

```bash
# å¯åŠ¨æœåŠ¡ç«¯ (é»˜è®¤ kvs å¼•æ“ï¼Œç›‘å¬ 127.0.0.1:4000)
cargo run --bin kvs-server

# å¯åŠ¨æœåŠ¡ç«¯ (æŒ‡å®š sled å¼•æ“å’Œåœ°å€)
cargo run --bin kvs-server -- --engine sled --addr 127.0.0.1:5000

# å®¢æˆ·ç«¯æ“ä½œ
cargo run --bin kvs-client -- set mykey myvalue
cargo run --bin kvs-client -- get mykey
cargo run --bin kvs-client -- rm mykey

# æŒ‡å®šæœåŠ¡ç«¯åœ°å€
cargo run --bin kvs-client -- --addr 127.0.0.1:5000 get mykey
```

## æ„å»ºä¸æµ‹è¯•

```bash
cargo build                    # æ„å»º
cargo test                     # è¿è¡Œå…¨éƒ¨ 23 ä¸ªæµ‹è¯•
cargo bench                    # è¿è¡Œ kvs vs sled åŸºå‡†æµ‹è¯•
cargo clippy --all-targets     # lint æ£€æŸ¥
cargo fmt --check              # æ ¼å¼æ£€æŸ¥
```

## ä»£ç è´¨é‡

- `#![deny(missing_docs)]` å¼ºåˆ¶æ–‡æ¡£è¦†ç›–
- æ‰€æœ‰å…¬å…± API åŒ…å« `# Errors` æ–‡æ¡£æ®µ
- åº“ä»£ç é›¶ clippy è­¦å‘Š
- `thiserror` å£°æ˜å¼é”™è¯¯ç±»å‹ï¼Œè¦†ç›– I/Oã€åºåˆ—åŒ–ã€ç½‘ç»œã€å¼•æ“ç­‰åœºæ™¯
- å¹¶å‘å®‰å…¨ï¼šTOCTOU é˜²æŠ¤ã€panic æ¢å¤ã€æ— é”è¯»è·¯å¾„

## è®¸å¯è¯

MIT OR Apache-2.0
